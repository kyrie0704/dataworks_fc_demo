# 小皮数据部数据开发指引

## 一、简述

为提高小皮数据部门的数据开发效率，特引入此开发规范；目前小皮数据部开发组采用的技术框架主要是GitHub+云效流水线+函数计算FC+DataWorks+MaxCompute组合，这种组合可以用于实现全面的代码管理、构建、部署、函数计算以及数据存储和处理。

1、GitHub 可以用于存储和管理代码，开发者可以在这里协作开发项目。

2、云效流水线可以自动化构建和部署软件项目，大大提高开发效率。

3、函数计算是一种无服务器计算服务，可以按需创建、部署和运行函数，非常适合处理高并发、突发性的计算任务。

4、DataWorks 可以进行数据集成和数据处理，帮助用户实现数据的高效流转和利用。

5、MaxCompute 是一种分布式数据仓库，可以存储海量数据并提供稳定的计算能力，非常适合进行大规模的数据分析和处理。

该组合可以实现在GitHub上存储和管理代码，使用云效流水线自动构建和部署代码，使用函数计算FC运行代码，使用DataWorks进行数据集成和处理，使用MaxCompute存储和计算大规模数据。通过这种组合，可以大大提高开发、测试、部署和数据处理效率，同时降低基础设施的成本和维护的复杂性。

## 二、DataWorks

### 1、概述

阿里云Dataworks是阿里云的重要产品，提供了数据集成、数据建模、数据开发、数据分析、数据治理等全方位的产品服务。为了提高数据开发效率，保证数据质量，本规范详细规定了Dataworks开发过程中的一系列要求和标准。

### 2、数据源创建

（1）数据源类型选择

根据上游数据库的类型，选择合适的数据源类型。对于关系型数据库，有两种数据源类型可选：阿里云实例模式和连接串模式。建议使用阿里云实例模式来新增数据源。

（2）数据源测试连通性

在输入数据库名、用户名和密码后，需要测试连通性后才能点击完成，保证数据源是处于可联通的状态。

### 3、建表及上传数据

（1）创建表结构

​	①在工作空间中配置MaxCompute，进入数据开发页面，在菜单栏中选择【表管理】单击【新建】。

​	②在新建表对话框中，输入表名并提交。表名应符合以下规范：

* 表名不能超过64个字符；
* 表名必须以字母开头；
* 表名不能包含中文或特殊字符。

（2）上传数据

​	①通过数据集成模块，从多个不同的数据源导入业务数据至工作空间。支持的数据源类型包括但不限于MySQL、SQL Server、OSS等。

​	②本地文本文件上传的限制如下：

* 文件类型：仅支持.txt、.csv、.log类型的文件；
* 文件大小：不能超过30MB；
* 操作对象：支持分区表导入和非分区表导入，但不支持分区值为中文、and（&）、星号（*）等特殊字符。

（3）表命名规范

​	①ODS层表名：ods\_来源\_业务过程_日期颗粒度

​	②DWD层表名：dwd\_来源\_业务过程_日期颗粒度

​	③DWM层表名：dwm\_来源\_业务过程_地域颗粒度_日期颗粒度

​	④DWS层表名：dws\_来源\_业务过程_地域颗粒度_日期颗粒度

​	⑤DIM层表名：dim_业务信息

（4）表字段类型规范

​	①数值类型

* 整型数值：BIGINT
* 浮点型数值：DOUBLE

​	②文本类型

* 短文本：VARCHAR
* 长文本：STRING

​	③时间类型

* 日期：DATE
* 日期时间：DATETIME
* 时间戳：TIMESTAMP

​	④布尔类型

* 布尔：BOOLEAN

​	⑤复杂类型

* JSON

> 字段类型详情请参考：[MaxCompute2.0数据类型版本](https://help.aliyun.com/zh/maxcompute/user-guide/maxcompute-v2-0-data-type-edition/?spm=a2c4g.11186623.0.0.39961a0aBJ125k)

### 4、开发流程指引

登录DataWorks控制台，单击左侧导航栏的【数据建模与开发】>【数据开发】，在下拉框中选择对应工作空间后单击【进入数据开发】

**步骤一：新建业务流程**

DataWorks以业务流程为中心组织数据开发，通过各类型开发节点的容器看板，将相关工具、优化及管理操作围绕看板对象进行组织，使开发管理更加方便智能。您可根据业务需求，将同类型业务统一放置一个业务流程。

​	（1）进入数据开发。

​	（2）创建业务流程。

			- 创建方式一：鼠标悬停至【+新建】图标，单击【新建业务流程】
			- 创建方式二：右键单击数据开发左侧目录树的【业务流程】，选择【新建业务流程】

​	（3）配置业务流程的名称及描述

**步骤二：新建表**

DataWorks的数据开发节点会对您的源数据进行清洗加工，因此，您需先在引擎创建用于接收数据清洗结果的表，并定义表结构。

​	（1）创建表

* 在步骤一创建的业务流程中，展开子目录，右键单击【MaxCompute】>【表】，选择【新建表】
* 配置表名称、引擎实例等信息
* 建表语句请参考[建表语句](https://help.aliyun.com/zh/dataworks/use-cases/create-tables-and-upload-data#step-5bl-xnp-mma)

​	（2）配置表结构

* 进入表编辑页面，切换至DDL模式，通过DDL语句配置表结构。生成表结构后，在【基本属性】区域输入表的【中文名】，并将其提交至开发环境与生产环境，提交成功后可在对应环境的引擎项目查看该表。

**步骤三：新建节点**

根据业务需求，选择合适的节点类型进行开发。目前DataWorks的节点分为数据同步类型节点与计算类型节点两大类，实际开发过程中，您通常需要先通过离线同步任务将业务数据库中的数据同步至数仓中，再通过DataWorks计算节点对数仓中的表数据进行清洗加工。

​	（1）创建节点

* 方式一：在目录树的【业务流程】中找到步骤一创建的业务流程；右键单击所需引擎，在【新建节点】下选择合适节点。
* 方式二：在目录树的【业务流程】中找到步骤一创建的业务流程；双击该业务流程，进入业务流程面板；在面板左侧导航栏单击所需节点，或将所需节点拖拽至面板。

​	（2）配置节点引擎实例、名称等信息。建议将结果表名称作为节点的名称，以便快速定位该节点产出的表数据。

**步骤四：编辑节点**

在业务流程目录树或业务流程面板中找到步骤三创建的节点，双击进入节点编辑页面。根据节点类型，通过对应数据库的语法编写业务代码。

**步骤五：定义节点调度属性**

通过定义节点的调度相关属性，实现周期调度运行目标节点。在节点编辑页面右侧导航栏的【调度配置】，根据业务需求配置相关属性。

**步骤六：调试代码**

调试代码逻辑，保障代码编写的正确性。

​	（1）代码行快捷运行。需要快捷运行代码片段时，可选择此方式。

​	（2）工具栏运行。需要频繁调试全量代码时，可选择此方式。

​	（3）工具栏高级运行。需要修改代码中的变量赋值，可选择此方式。

**步骤七：保存并提交节点**

节点配置并测试完成后，您需要保存节点配置，并提交节点至开发环境。

> 说明：需在步骤五中配置了**重跑属性**及**依赖的上游节点**后才可提交。

**步骤八：冒烟测试**

为保障生产任务高效运行，避免计算资源浪费，建议您在任务发布前先对任务进行冒烟测试。冒烟测试需在开发环境执行，因此您需先将节点提交至开发环境。

**步骤九：发布任务**

若当前工作空间为简单模式工作空间，任务提交后便可周期性调度；若当前工作空间为标准模式工作空间，任务提交后仅处于待发布状态，您需参考该步骤将任务发布生产，发布后该任务才可进行周期性调度。您可进入【运维中心】> 【周期任务运维】查看发布至生产环境的离线调度任务，并执行相关运维操作。

### 5、相关规范

（1）数据开发规范

​	在进行数据开发时，应遵循相应的开发规范，如编写简洁明了的代码，使用合适的算法和工具等。

（2）数据质量规范

​	为保证数据质量，需对数据进行清洗和校验。清洗主要包括去除重复数据、处理缺失值、异常值等；校验主要包括核对数据的完整性、准确性等。

（3）数据安全规范

​	在开发过程中，必须遵循阿里云Dataworks的安全规范，包括但不限于用户认证、访问控制、数据加密等。开发者需保护好自己的账号密码和密钥，避免泄露重要信息。

（4）数据治理规范

​	开发者需了解并遵守阿里云Dataworks的数据治理规则，包括数据的分类、存储、备份、恢复等。开发者需对自己的数据进行有效的管理和维护，确保数据的可用性和完整性。

（5）技术支持与文档规范

​	开发者在遇到问题时，应首先查阅阿里云Dataworks的官方文档和社区讨论。如果问题无法解决，可以向阿里云的技术支持团队寻求帮助。开发者在使用Dataworks的过程中，应保持对新技术和新功能的关注，及时更新自己的知识储备。

（6）代码审查与测试规范

​	开发者在提交代码之前，应对代码进行自我审查和测试，确保代码的质量和性能。开发者应遵循代码审查和测试的规范，按照要求提交高质量的代码。同时，开发者应保留好代码的版本记录和测试结果，以便后续的跟踪和排查问题。

### 6、适用需求场景

适用于处理大量数据、进行复杂的数据分析和处理、需要较高的数据处理性能的开发任务。

（1）数仓各层数据的处理

（2）大体量的数据处理

### 7、示例

（1）IBP预警项目

（2）ERP数据处理项目

## 三、函数计算FC

### 1、概述

本规范旨在为阿里云函数计算FC的开发过程提供指导和规范，以确保函数的可用性、可维护性和可扩展性。开发者在编写函数代码时，应遵循本规范的要求。

### 2、背景信息

服务（Service）是函数计算的基本资源单位。您可以在服务级别上授权、配置日志和创建函数等。函数（Function）是调度与运行的基本单位，更是一段代码的处理逻辑。您需要根据函数计算提供的函数接口形式编写代码，并将代码以函数的形式部署到函数计算。函数计算中的服务对应于软件应用架构领域中的微服务。在函数计算平台构建应用时，首先根据需求将业务逻辑抽象为微服务，然后再实现为函数计算中的服务。

### 3、开发流程指引

首次使用需要先开通函数计算服务；请使用RAM用户角色使用函数计算服务。

**步骤一：创建服务**

（1）登录到函数计算控制台，在左侧导航栏，单击【服务及函数】

（2）在顶部菜单栏，选择地域，然后在服务列表页面，单击【创建服务】

（3）在创建服务面板，填写服务名称和描述，并按需设置相关配置项，然后单击【确定】

**步骤二：创建函数**

（1）点击进入步骤一创建的服务页面，在左侧导航栏，单击【函数管理】，在此页面中单击【创建函数】

（2）在创建函数页面，选择【使用内置运行时创建】配置相关配置项，然后单击【创建】

​	①基本设置

* 填写函数名称。
* 请求处理程序类型按需选择。

> 处理事件请求：通过定时器、调用API/SDK或其他阿里云服务的触发器来触发函数执行
>
> 处理HTTP请求：用于处理HTTP请求或Websocket请求的函数。

​	②函数代码

* 运行环境：选择和本次开发环境一致的(建议使用Python 3.9)。
* 代码上传方式：按需选择。

> 使用云效一键自动化部署代码方式的可选择**使用示例代码**；
>
> 直接通过本地部署的可选择**通过ZIP包上传代码**或**通过文件夹上传代码**

​	③高级配置

* 规格方案：按需选择
* 实例并发度：按需选择
* 执行超时时间：按需配置(需大于程序运行总时长，默认为60秒)
* 请求处理程序：根据需要执行的函数和函数所在文件进行配置(默认为index.handler)
* 时区：按需配置(默认为世界时间)

​	④环境变量

​	⑤触发器配置

> 可以使用触发器触发函数的执行；仅当请求处理程序类型为**事件请求**时，才可配置相关触发器。

（3）配置公共依赖库

​	层可以为您提供公共依赖库、运行时环境及函数扩展等发布与部署能力。您可以将函数依赖的公共库提炼到层或者使用函数计算官方公共层，以减少部署或更新函数时的代码包体积。可根据对应的语言选择构建相关的层，以下以创建使用Python语言开发的层。

​	①创建自定义层

* 登录函数计算控制台，在左侧导航栏选择【高级功能】>【层管理】

* 在顶部菜单栏，选择地域，然后在层管理页面，单击【创建层】

* 在创建层页面设置相关参数，然后单击创建

  | 参数       | 描述                               |
  | :--------- | ---------------------------------- |
  | 名称       | 输入层的名称                       |
  | 描述       | 输入层的描述信息                   |
  | 兼容运行时 | 选择对应的Python版本               |
  | 层上传方式 | 在线构建依赖层并选择对应的构建环境 |

> 已创建的层或相关层版本暂不支持修改，如果您需要修改层的相关配置，可以创建新的层或创建新版本。需要注意的是，如果引用的层版本已删除，在更新层配置时，必须先删除该引用。

​	②配置自定义层

* 登录函数计算控制台，在左侧导航栏，单击【服务与函数】
* 在顶部菜单栏，选择地域，然后在服务列表页面，单击目标服务
* 在函数管理页面，单击目标函数操作列的【配置】
* 在层区域，单击【+添加层】，从下拉列表中选择【添加自定义层】，在自定义层和层版本下拉列表选择所需的配置，然后单击【保存】

​	③删除层与层版本

* 删除层：在层管理页面，单击目标层操作列的【更多】>【删除】
* 删除层版本：单击目标层名称，在层详情页面的版本管理区域，单击目标层版本操作列的【删除】

**步骤三：执行函数**

（1）点击进入步骤二创建的函数页面，然后选择【函数代码】页签，单击【测试函数】

（2）执行完毕后，你可以在【函数代码】页签查看执行结果和详细的日志信息。

### 4、开发流程规范

（1）需求分析

​	在开始编写函数代码之前，开发者应进行详细的需求分析，了解函数的功能、输入输出参数、运行环境等要求。

（2）开发环境准备

​	根据需求分析结果，准备相应的开发环境，包括创建阿里云函数计算服务、配置所需资源等。

（3）代码编写

​	根据需求分析结果，编写函数代码。函数代码应简洁明了、易于维护，并遵循阿里云函数计算的开发规范。

（4）测试与调试

​	在完成代码编写后，开发者应先在本地对函数进行详细的测试和调试，确保函数的正确性和稳定性。

（5）部署与发布

​	经过测试和调试后，开发者可将函数代码部署到阿里云函数计算服务中，并按照需求进行配置和发布。

### 5、代码编写规范

（1）代码格式规范【强制】

​	函数代码应采用简洁明了的格式，易于阅读和理解。开发者应遵循阿里云函数计算的开发规范，以及适用的编码标准和惯例。

（2）变量命名规范【强制】

​	在函数代码中，变量的命名应具有描述性，尽量避免使用缩写或简写形式，并遵循统一的命名规则。

（3）函数命名规范【强制】

​	函数命名应具有描述性，能够清晰地表达函数的功能。函数名应采用小写，用下划线分割，并遵循统一的命名规则。

（4）输入输出规范【建议】

​	函数的输入输出参数应进行适当的验证和校验，确保输入的有效性和安全性。函数的输出应符合预期的格式和内容，并遵循统一的输出规范。

（5）错误处理规范【强制】

​	在函数代码中，应充分考虑错误处理和异常情况的处理。对于可能出现的错误和异常，应进行捕获和处理，并给出适当的错误提示和日志记录。

（6）日志记录规范【建议】

​	在函数代码中，应进行适当的日志记录，以便于跟踪和排查问题。日志记录应包括关键的代码执行过程、错误信息和异常情况等。

（7）安全规范【强制】

​	在编写函数代码时，开发者应遵循阿里云函数计算的安全规范，包括但不限于访问控制、加密与解密等。开发者应保护好自己的函数代码和相关配置信息，避免泄露重要信息。

（8）性能优化规范【建议】

​	在编写函数代码时，开发者应考虑函数的性能和资源利用率。通过优化算法和数据结构，提高函数的响应速度和处理能力。同时，合理使用计算资源，避免浪费和过度消耗。

### 6、适用需求场景

适用于快速原型开发、简单性、易用性并且对数据处理性能要求不高的开发任务。

（1）Web场景，用于处理HTTP请求

（2）调用API/SDK或其他阿里云服务的触发器来触发函数的

（3）高速请求处理的小型应用

（4）相对独立的定时任务

### 7、示例

（1）产品时光机网站

（2）云听原始评论数据接入

（3）MDM数据同步

## 四、云效流水线

### 1、概述

本规范旨在为阿里云云效流水线的开发过程提供指导和规范，以确保流水线的可用性、可维护性和可扩展性。开发者在创建和配置流水线时，应遵循本规范的要求。

### 2、开发流程规范

（1）登录云效平台

​	首先，开发者需要登录阿里云云效平台，并选择相应的项目和流水线进行开发。没有对应流水线权限的需向该流水线管理者申请权限。

（2）创建流水线

​	在云效平台中，开发者可以创建新的流水线。点击“新建流水线”，选择“其他”中的“其他 · 函数计算 (FC) 应用发布”并点击“创建”；在创建其他类型的流水线时，开发者应选择适合自己项目的模板，并根据项目需求配置相应的参数。

（3）添加流水线源

​	在流水线源配置中，选择代码源为“Github”，并选择对应的命名空间、仓库以及分支并点击“添加”；在配置其他类型的流水线源时，开发者应选择合适的代码仓库和分支，以便从源代码中获取数据并执行相应的构建任务。

（4）编辑函数计算(fc)应用发布

​	在函数应用发布中，开发者需要在编辑界面配置好阿里函数计算部署，选择需要部署的地域、服务名称和函数名称，源码类型选择“本地代码”，代码路径填写“.”。当流水线源选择为GitHub或涉及到海外服务时，为保证处理速度可将构建集群选择为“云效中国香港构建集群”

（5）保存并运行流水线

​	在完成流水线的配置后，开发者应保存流水线并运行。流水线的运行应包括申请运行环境、清理工作区、克隆代码、流水线缓存、阿里函数计算部署和缓存上传等步骤。

## 五、GitHub

### 1、概述

本规范旨在为使用GitHub进行代码管理的开发过程提供指导和规范，以确保代码的可读性、可维护性和可扩展性。所有参与开发的成员都应遵守本规范。

### 2、代码提交规范

（1）提交信息清晰明了

​	每次提交的注释应清晰明了，描述所做的更改和原因。

（2）遵循提交时间点原则

​	建议在每天的上午进行代码提交，避免在临近下班或周末的时间点进行大的代码更改。

（3）避免提交未测试的代码

​	所有的代码更改都应通过测试，未经测试的代码不得提交。

（4）确保代码质量

​	提交前应确保代码的质量，包括代码的可读性、可维护性、性能等。

（5）遵循提交大小原则

​	每个提交的代码量不宜过大，避免一次性提交过多的代码。

### 3、代码审查规范

(1) 建立代码审查机制

​	所有的代码更改（无论大小）都应经过代码审查，确保代码质量。

(2)关注代码质量

​	审查时应关注代码的质量，包括可读性、可维护性、性能等。

(3)检查测试情况

​	审查时应检查代码的测试情况，确保所有的测试都通过。

(4)注意安全问题

​	审查时应关注可能的安全问题，如权限设置、敏感信息处理等。

### 4、分支管理规范

(1)主分支保持稳定

​	主分支（master/main分支）应保持稳定，避免频繁的更改。所有的新特性和修复都应在子分支中进行，然后通过Pull Request合并到主分支。

(2)使用分支进行开发

​	建议使用分支进行开发，避免在主分支中进行大量的开发工作。

(3)及时合并分支

​	及时合并子分支到主分支，避免分支之间的差异过大。

(4)及时删除不再使用的分支

​	当一个分支不再使用时，应及时删除，避免分支数量过多。

### 5、其他规范

（1）保持仓库整洁

​	定期清理仓库，删除不必要的文件和提交。

（2）文档化重要更改

​	对于重要的更改和功能，应在仓库的文档中进行记录。
